# Инструкция по подключению к MongoDB

## 1. Подключение к удаленной базе данных

Если вы используете удаленную базу данных, выполните следующие шаги:

1. Получите URL удаленной базы данных.
2. Откройте уже существующий файл .env в корневом каталоге вашего проекта.
3. Добавьте строки подключения после = в MONGO_URL и MONGO_URL_TEST

## 2. Локальный запуск с использованием Docker

- Убедитесь, что у вас установлен Docker.
- В корневом каталоге для подключения уже есть необходимые файлы: docker-compose.yml и Dockerfile.

### 1. Изменение файла hosts на macOS и Windows

#### 1.1 ***Изменение файла hosts на macOS***

1. Открыть Терминал:

Нажмите `Cmd + Space`, введите **Terminal**, нажмите `Enter`.

2. Открыть файл hosts:

- Выполните команду:

```sh
  sudo nano /etc/hosts
```

- Введите пароль администратора при запросе.

3. Редактирование файла:

Используйте стрелки для навигации и добавьте/измените записи.
Пример для привязки `mongo1`, `mongo2`, `mongo3` к `localhost`:

```sh
  127.0.0.1   mongo1
  127.0.0.1   mongo2
  127.0.0.1   mongo3
```

4. Сохранение и выход:

- Нажмите Ctrl + X, чтобы выйти.
- Нажмите Y, чтобы подтвердить изменения.
- Нажмите Enter, чтобы сохранить файл.

#### 1.2 ***Изменение файла hosts на Windows***

1. Открыть Блокнот от имени администратора:

Нажмите `Win + S`, введите **Блокнот**, нажмите `Правой кнопкой мыши → Запуск от имени администратора`.

2. Открыть файл hosts:

- В Блокноте нажмите `Файл → Открыть`.
- Перейдите в `C:\Windows\System32\drivers\etc`.
- Выберите `hosts` (если его не видно, выберите "Все файлы" в фильтре).

3. Редактирование файла:

Добавьте/измените записи:

```sh
  127.0.0.1   mongo1
  127.0.0.1   mongo2
  127.0.0.1   mongo3
```

4. Сохранение и выход:

- Нажмите `Ctrl + S`, чтобы сохранить файл.
- Закройте Блокнот.

### 2. Создание ключа авторизации для всех реплик

1. Откройте `bash` терминал в Windows или стандартный терминал на macOS в папке проекта и выполните команду:

```bash
  openssl rand -base64 756 > mongo-keyfile
```

2. Убедитесь, что файл `mongo-keyfile` с ключем создался.

### 3. Запуск узлов

1. Запустите MongoDB с помощью Docker Compose:

```bash
   docker compose up -d
```

2. Откройте Docker Desktop и проверьте, что все узлы запустились.

### 4. Инициализация кластера

1. Инициализируйте кластер, выполнив следующую команду:

```bash
  docker exec -it mongo1 mongosh -u root -p example --eval 'rs.initiate({_id: "rs0", members: [{ _id: 0, host: "mongo1:27017" }, { _id: 1, host: "mongo2:27018" }, { _id: 2, host: "mongo3:27019" }]})'
```

2. Проверьте статус кластера, чтобы убедиться, что все реплики работают:

```bash
  docker exec -it mongo1 mongosh --username root --password example --authenticationDatabase admin --eval "rs.status()"
```

### 5. Строка подключения

В вашем приложении используйте следующую строку подключения:

typescript

```typescript
    const connectionString = 'mongodb://root:example@localhost:27017,localhost:27018,localhost:27019/nest?retryWrites=true&loadBalanced=false&replicaSet=rs0&authSource=admin&readPreference=primary'
```
